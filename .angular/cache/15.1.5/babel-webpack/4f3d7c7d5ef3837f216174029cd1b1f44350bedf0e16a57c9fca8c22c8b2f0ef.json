{"ast":null,"code":"import { DegysEvent } from '../../shared/models/event.model';\nimport * as moment from 'moment';\nimport { Subject, Subscription } from 'rxjs';\nimport { Message } from '../../../shared/models/message.model';\nimport { fadeStateTrigger } from '../../../shared/animations/fade.animation';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../shared/services/events.service\";\nimport * as i2 from \"../../shared/services/bill.service\";\nimport * as i3 from \"@angular/common\";\nimport * as i4 from \"@angular/forms\";\nimport * as i5 from \"./add-event-choose/add-event-choose.component\";\nfunction AddEventComponent_option_12_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"option\", 26);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const c_r10 = ctx.$implicit;\n    i0.ɵɵproperty(\"value\", c_r10.id);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate1(\" \", c_r10.name, \" \");\n  }\n}\nfunction AddEventComponent_div_16_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\")(1, \"label\");\n    i0.ɵɵelement(2, \"input\", 27);\n    i0.ɵɵelementStart(3, \"span\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const t_r11 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"value\", t_r11.type)(\"ngModel\", \"outcome\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(t_r11.label);\n  }\n}\nfunction AddEventComponent_span_22_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\", 28);\n    i0.ɵɵtext(1, \" \\u041F\\u043E\\u043B\\u0435 \\u043E\\u0431\\u044F\\u0437\\u0430\\u0442\\u0435\\u043B\\u044C\\u043D\\u043E\\u0435 \\u0434\\u043B\\u044F \\u0437\\u0430\\u043F\\u043E\\u043B\\u043D\\u0435\\u043D\\u0438\\u044F. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction AddEventComponent_span_23_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\", 28);\n    i0.ɵɵtext(1, \" \\u0417\\u043D\\u0430\\u0447\\u0435\\u043D\\u0438\\u0435 \\u043D\\u0435 \\u043C\\u043E\\u0436\\u0435\\u0442 \\u0431\\u044B\\u0442\\u044C \\u043C\\u0435\\u043D\\u044C\\u0448\\u0438\\u043C 1. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction AddEventComponent_span_29_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\", 28);\n    i0.ɵɵtext(1, \" \\u041F\\u043E\\u043B\\u0435 \\u043E\\u0431\\u044F\\u0437\\u0430\\u0442\\u0435\\u043B\\u044C\\u043D\\u043E\\u0435 \\u0434\\u043B\\u044F \\u0437\\u0430\\u043F\\u043E\\u043B\\u043D\\u0435\\u043D\\u0438\\u044F. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction AddEventComponent_div_32_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 29)(1, \"label\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r8 = i0.ɵɵnextContext();\n    i0.ɵɵstyleProp(\"color\", ctx_r8.calculatedBill > 0 ? \"green\" : \"red\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate2(\"\\u041E\\u0441\\u0442\\u0430\\u0442\\u043E\\u043A \\u043D\\u0430 \\u0441\\u0447\\u0435\\u0442\\u0443: \", ctx_r8.calculatedBill, \" \", ctx_r8.bill.currency, \"\");\n  }\n}\nfunction AddEventComponent_div_33_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r9 = i0.ɵɵnextContext();\n    i0.ɵɵclassMapInterpolate1(\"alert alert-\", ctx_r9.message.type, \"\");\n    i0.ɵɵproperty(\"@fade\", undefined);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate(ctx_r9.message.text);\n  }\n}\nconst _c0 = function (a0) {\n  return {\n    \"has-error\": a0\n  };\n};\nexport let AddEventComponent = /*#__PURE__*/(() => {\n  class AddEventComponent {\n    constructor(eventsService, billService) {\n      this.eventsService = eventsService;\n      this.billService = billService;\n      this.subscriptions = new Subscription();\n      this.types = [{\n        type: 'income',\n        label: 'Доход'\n      }, {\n        type: 'outcome',\n        label: 'Расход'\n      }];\n      this.events = [];\n      // from parent to child\n      this.addEvent = new Subject();\n      this.message = new Message();\n      this.user = JSON.parse(window.localStorage.getItem('user'));\n    }\n    ngOnInit() {\n      this.subscriptions.add(this.billService.getBill(this.user.bill).subscribe(bill => {\n        this.bill = bill;\n        this.calculatedBill = bill.value;\n      }));\n    }\n    onSubmit(form) {\n      // tslint:disable-next-line:prefer-const\n      let {\n        amount,\n        description,\n        category,\n        type\n      } = form.value;\n      if (amount < 0) {\n        amount *= -1;\n      }\n      const event = new DegysEvent(type, amount, +category, moment().format('DD.MM.YYYY HH:mm:ss'), description);\n      this.addEvent.next(event);\n    }\n    saveEvents() {\n      console.log(this.events);\n      this.subscriptions.add(this.eventsService.addEvents(this.events).subscribe(res => {\n        const successSavedEvents = res.filter(e => e.id !== undefined);\n        if (successSavedEvents.length === this.events.length) {\n          this.updateBill(successSavedEvents);\n          console.log('SUCCESS: ', res);\n        } else {\n          console.log('NOT-SUCCESS: ', res);\n          this.updateBill(successSavedEvents);\n          this.addEvent.next(null);\n          res.filter(e => e.id === undefined).forEach(ev => this.addEvent.next(ev));\n          this.message.showMessage('danger', 'Ошибка! Данные события не сохранились. Попробуйте еще раз.');\n        }\n      }));\n    }\n    choosedEvents(eventsData) {\n      this.events = eventsData.events;\n      this.calculatedBill = this.bill.value + eventsData.totalAmount;\n      if (this.calculatedBill < 0) {\n        this.message.showMessage('danger', `Недостаточно средств!!!  ${this.calculatedBill} ${this.bill.currency}`);\n      }\n      console.log(this.events);\n    }\n    updateBill(successSavedEvents) {\n      const newBillValue = this.bill.value + successSavedEvents.reduce((acumulateVal, currentVal) => {\n        return currentVal.type === 'outcome' ? acumulateVal - currentVal.amount : acumulateVal + currentVal.amount;\n      }, 0);\n      const newBill = {\n        value: newBillValue,\n        currency: this.bill.currency,\n        userId: this.user.id,\n        id: this.bill.id\n      };\n      this.subscriptions.add(this.billService.updateBill(newBill).subscribe(bill => {\n        this.addEvent.next(null);\n        this.bill = bill;\n        this.calculatedBill = bill.value;\n        this.message.showMessage('success', 'События и счет сохранены!');\n      }));\n    }\n    ngOnDestroy() {\n      this.subscriptions.unsubscribe();\n    }\n  }\n  AddEventComponent.ɵfac = function AddEventComponent_Factory(t) {\n    return new (t || AddEventComponent)(i0.ɵɵdirectiveInject(i1.EventsService), i0.ɵɵdirectiveInject(i2.BillService));\n  };\n  AddEventComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: AddEventComponent,\n    selectors: [[\"degys-add-event\"]],\n    inputs: {\n      categories: \"categories\"\n    },\n    decls: 37,\n    vars: 18,\n    consts: [[1, \"card\"], [1, \"card-header\", \"bordered\"], [1, \"header-block\"], [1, \"title\"], [1, \"card-block\"], [3, \"ngSubmit\"], [\"f\", \"ngForm\"], [1, \"form-group\"], [\"for\", \"category\", 1, \"control-label\"], [\"id\", \"category\", \"required\", \"\", \"name\", \"category\", 1, \"form-control\", 3, \"ngModel\"], [3, \"value\", 4, \"ngFor\", \"ngForOf\"], [1, \"control-label\"], [4, \"ngFor\", \"ngForOf\"], [1, \"form-group\", 3, \"ngClass\"], [\"for\", \"amount\", 1, \"control-label\"], [\"type\", \"number\", \"id\", \"amount\", \"name\", \"amount\", \"min\", \"1\", \"required\", \"\", 1, \"form-control\", 3, \"ngModel\"], [\"amount\", \"ngModel\"], [\"class\", \"form-help-text\", 4, \"ngIf\"], [\"for\", \"description\", 1, \"control-label\"], [\"type\", \"text\", \"id\", \"description\", \"name\", \"description\", \"ngModel\", \"\", \"required\", \"\", 1, \"form-control\"], [\"description\", \"ngModel\"], [\"type\", \"submit\", 1, \"btn\", \"btn-primary\", 3, \"disabled\"], [\"class\", \"bill\", \"style\", \"float: right\", 3, \"color\", 4, \"ngIf\"], [3, \"class\", 4, \"ngIf\"], [3, \"addedEvent\", \"choosedEvents\"], [\"type\", \"button\", 1, \"btn\", \"btn-primary\", 3, \"disabled\", \"click\"], [3, \"value\"], [\"name\", \"type\", \"type\", \"radio\", 1, \"radio\", 3, \"value\", \"ngModel\"], [1, \"form-help-text\"], [1, \"bill\", 2, \"float\", \"right\"]],\n    template: function AddEventComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        const _r12 = i0.ɵɵgetCurrentView();\n        i0.ɵɵelementStart(0, \"div\", 0)(1, \"div\", 1)(2, \"div\", 2)(3, \"h3\", 3);\n        i0.ɵɵtext(4, \"\\u0414\\u043E\\u0431\\u0430\\u0432\\u0438\\u0442\\u044C \\u0441\\u043E\\u0431\\u044B\\u0442\\u0438\\u0435\");\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵelementStart(5, \"div\", 4)(6, \"form\", 5, 6);\n        i0.ɵɵlistener(\"ngSubmit\", function AddEventComponent_Template_form_ngSubmit_6_listener() {\n          i0.ɵɵrestoreView(_r12);\n          const _r0 = i0.ɵɵreference(7);\n          return i0.ɵɵresetView(ctx.onSubmit(_r0));\n        });\n        i0.ɵɵelementStart(8, \"div\", 7)(9, \"label\", 8);\n        i0.ɵɵtext(10, \"\\u0412\\u044B\\u0431\\u0435\\u0440\\u0438\\u0442\\u0435 \\u043A\\u0430\\u0442\\u0435\\u0433\\u043E\\u0440\\u0438\\u044E\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(11, \"select\", 9);\n        i0.ɵɵtemplate(12, AddEventComponent_option_12_Template, 2, 2, \"option\", 10);\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(13, \"div\", 7)(14, \"label\", 11);\n        i0.ɵɵtext(15, \"\\u0412\\u044B\\u0431\\u0435\\u0440\\u0438\\u0442\\u0435 \\u0442\\u0438\\u043F\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(16, AddEventComponent_div_16_Template, 5, 3, \"div\", 12);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(17, \"div\", 13)(18, \"label\", 14);\n        i0.ɵɵtext(19, \"\\u0412\\u0432\\u0435\\u0434\\u0438\\u0442\\u0435 \\u0441\\u0443\\u043C\\u043C\\u0443\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelement(20, \"input\", 15, 16);\n        i0.ɵɵtemplate(22, AddEventComponent_span_22_Template, 2, 0, \"span\", 17);\n        i0.ɵɵtemplate(23, AddEventComponent_span_23_Template, 2, 0, \"span\", 17);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(24, \"div\", 13)(25, \"label\", 18);\n        i0.ɵɵtext(26, \"\\u0412\\u0432\\u0435\\u0434\\u0438\\u0442\\u0435 \\u043E\\u043F\\u0438\\u0441\\u0430\\u043D\\u0438\\u0435\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelement(27, \"input\", 19, 20);\n        i0.ɵɵtemplate(29, AddEventComponent_span_29_Template, 2, 0, \"span\", 17);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(30, \"button\", 21);\n        i0.ɵɵtext(31, \"\\u0414\\u043E\\u0431\\u0430\\u0432\\u0438\\u0442\\u044C\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(32, AddEventComponent_div_32_Template, 3, 4, \"div\", 22);\n        i0.ɵɵtemplate(33, AddEventComponent_div_33_Template, 2, 5, \"div\", 23);\n        i0.ɵɵelementStart(34, \"degys-add-event-choose\", 24);\n        i0.ɵɵlistener(\"choosedEvents\", function AddEventComponent_Template_degys_add_event_choose_choosedEvents_34_listener($event) {\n          return ctx.choosedEvents($event);\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(35, \"button\", 25);\n        i0.ɵɵlistener(\"click\", function AddEventComponent_Template_button_click_35_listener() {\n          return ctx.saveEvents();\n        });\n        i0.ɵɵtext(36, \"\\u0421\\u043E\\u0445\\u0440\\u0430\\u043D\\u0438\\u0442\\u044C\");\n        i0.ɵɵelementEnd()()()();\n      }\n      if (rf & 2) {\n        const _r0 = i0.ɵɵreference(7);\n        const _r3 = i0.ɵɵreference(21);\n        const _r6 = i0.ɵɵreference(28);\n        i0.ɵɵadvance(11);\n        i0.ɵɵproperty(\"ngModel\", 1);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngForOf\", ctx.categories);\n        i0.ɵɵadvance(4);\n        i0.ɵɵproperty(\"ngForOf\", ctx.types);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngClass\", i0.ɵɵpureFunction1(14, _c0, _r3.invalid && _r3.touched || _r3.value <= 0));\n        i0.ɵɵadvance(3);\n        i0.ɵɵproperty(\"ngModel\", 1);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngIf\", _r3.invalid && _r3.touched);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", _r3.value <= 0);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngClass\", i0.ɵɵpureFunction1(16, _c0, _r6.invalid && _r6.touched));\n        i0.ɵɵadvance(5);\n        i0.ɵɵproperty(\"ngIf\", _r6.invalid && _r6.touched);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"disabled\", _r0.invalid || _r3.value <= 0);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngIf\", ctx.bill);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.message.text);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"addedEvent\", ctx.addEvent);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"disabled\", ctx.events.length === 0);\n      }\n    },\n    dependencies: [i3.NgClass, i3.NgForOf, i3.NgIf, i4.ɵNgNoValidate, i4.NgSelectOption, i4.ɵNgSelectMultipleOption, i4.DefaultValueAccessor, i4.NumberValueAccessor, i4.SelectControlValueAccessor, i4.RadioControlValueAccessor, i4.NgControlStatus, i4.NgControlStatusGroup, i4.RequiredValidator, i4.MinValidator, i4.NgModel, i4.NgForm, i5.AddEventChooseComponent],\n    data: {\n      animation: [fadeStateTrigger]\n    }\n  });\n  return AddEventComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}