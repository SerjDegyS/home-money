{"ast":null,"code":"import { mergeMap } from 'rxjs/operators';\nimport * as moment from 'moment';\nimport { fadeStateTrigger } from '../../shared/animations/fade.animation';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../shared/services/bill.service\";\nimport * as i2 from \"../shared/services/categories.service\";\nimport * as i3 from \"../shared/services/events.service\";\nimport * as i4 from \"@angular/platform-browser\";\nimport * as i5 from \"@angular/common\";\nimport * as i6 from \"../../shared/components/loader/loader.component\";\nimport * as i7 from \"./history-chart/history-chart.component\";\nimport * as i8 from \"./history-events/history-events.component\";\nimport * as i9 from \"./history-filter/history-filter.component\";\nfunction HistoryPageComponent_div_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 8);\n    i0.ɵɵelement(1, \"degys-loader\");\n    i0.ɵɵelementEnd();\n  }\n}\nconst _c0 = function (a0) {\n  return {\n    invisible: a0\n  };\n};\nfunction HistoryPageComponent_div_9_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r3 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\")(1, \"div\", 9)(2, \"div\", 10)(3, \"h4\");\n    i0.ɵɵtext(4, \" \\u0414\\u043E\\u0445\\u043E\\u0434 \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(5, \"degys-history-chart\", 11);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"div\", 12)(7, \"h4\");\n    i0.ɵɵtext(8, \" \\u0420\\u0430\\u0441\\u0445\\u043E\\u0434 \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(9, \"degys-history-chart\", 11);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelement(10, \"degys-history-events\", 13);\n    i0.ɵɵelementStart(11, \"div\", 14)(12, \"degys-history-filter\", 15);\n    i0.ɵɵlistener(\"onFilterApply\", function HistoryPageComponent_div_9_Template_degys_history_filter_onFilterApply_12_listener($event) {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.onFilterApply($event));\n    })(\"onFilterCancel\", function HistoryPageComponent_div_9_Template_degys_history_filter_onFilterCancel_12_listener() {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r4 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r4.onFilterCancel());\n    });\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(5);\n    i0.ɵɵproperty(\"data\", ctx_r1.chartIncomeData);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"data\", ctx_r1.chartOutcomeData);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"categories\", ctx_r1.categories)(\"events\", ctx_r1.filteredEvents);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngClass\", i0.ɵɵpureFunction1(6, _c0, !ctx_r1.isFilterVisible));\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"categories\", ctx_r1.categories);\n  }\n}\nexport let HistoryPageComponent = /*#__PURE__*/(() => {\n  class HistoryPageComponent {\n    constructor(billService, categoriesService, eventService, title) {\n      this.billService = billService;\n      this.categoriesService = categoriesService;\n      this.eventService = eventService;\n      this.title = title;\n      this.isLoaded = false;\n      this.billId = JSON.parse(window.localStorage.getItem('user')).bill;\n      this.categories = [];\n      this.events = [];\n      this.filteredEvents = [];\n      this.chartOutcomeData = [];\n      this.chartIncomeData = [];\n      this.isFilterVisible = false;\n      title.setTitle('История событий');\n    }\n    ngOnInit() {\n      // console.log(this.bill.id)\n      this.sub1 = this.billService.getBill(this.billId).pipe(mergeMap(bill => this.categoriesService.getCategories(bill.id).pipe(mergeMap(cats => {\n        this.categories = cats;\n        return this.eventService.getEventsForCategories(cats);\n      })))).subscribe(events => {\n        this.events = events;\n        this.setOriginalEvents();\n        this.calculateChartData();\n        this.isLoaded = true;\n      });\n    }\n    setOriginalEvents() {\n      this.filteredEvents = this.events.slice();\n    }\n    calculateChartData() {\n      this.chartOutcomeData = this.calculateChartDataByType('outcome');\n      this.chartIncomeData = this.calculateChartDataByType('income');\n    }\n    calculateChartDataByType(type) {\n      return this.categories.map(cat => {\n        return {\n          name: cat.name,\n          value: this.filteredEvents.filter(e => e.categoryId === cat.id && e.type === type).reduce((total, e) => total += e.amount, 0)\n        };\n      });\n    }\n    toggleFilterVisibility(dir) {\n      this.isFilterVisible = dir;\n    }\n    openFilter() {\n      this.toggleFilterVisibility(true);\n    }\n    onFilterApply(filterData) {\n      this.toggleFilterVisibility(false);\n      this.setOriginalEvents();\n      const startPeriod = moment().startOf(filterData.period).startOf('d');\n      const endPeriod = moment().endOf(filterData.period).endOf('d');\n      this.filteredEvents = this.filteredEvents.filter(e => filterData.types.indexOf(e.type) !== -1).filter(e => filterData.categories.indexOf(e.categoryId.toString()) !== -1).filter(e => {\n        const momentData = moment(e.date, 'DD.MM.YYYY HH.mm.ss');\n        return momentData.isBetween(startPeriod, endPeriod);\n      });\n      this.calculateChartData();\n    }\n    onFilterCancel() {\n      this.toggleFilterVisibility(false);\n      this.setOriginalEvents();\n      this.calculateChartData();\n    }\n    ngOnDestroy() {\n      this.sub1.unsubscribe();\n    }\n  }\n  HistoryPageComponent.ɵfac = function HistoryPageComponent_Factory(t) {\n    return new (t || HistoryPageComponent)(i0.ɵɵdirectiveInject(i1.BillService), i0.ɵɵdirectiveInject(i2.CategoriesService), i0.ɵɵdirectiveInject(i3.EventsService), i0.ɵɵdirectiveInject(i4.Title));\n  };\n  HistoryPageComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: HistoryPageComponent,\n    selectors: [[\"degys-history-page\"]],\n    decls: 10,\n    vars: 3,\n    consts: [[1, \"title-block\"], [1, \"title\", \"pull-left\"], [1, \"sparkline\", \"bar\"], [1, \"pull-right\"], [1, \"btn-sm\", \"btn\", \"btn-primary-outline\", 3, \"click\"], [1, \"fa\", \"fa-filter\"], [\"class\", \"text-center\", 4, \"ngIf\"], [4, \"ngIf\"], [1, \"text-center\"], [1, \"history-chart-group\"], [1, \"history-chart\", \"history-chart-income\"], [3, \"data\"], [1, \"history-chart\", \"history-chart-outcome\"], [3, \"categories\", \"events\"], [3, \"ngClass\"], [3, \"categories\", \"onFilterApply\", \"onFilterCancel\"]],\n    template: function HistoryPageComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"div\")(1, \"div\", 0)(2, \"h3\", 1);\n        i0.ɵɵtext(3, \" \\u0421\\u0442\\u0440\\u0430\\u043D\\u0438\\u0446\\u0430 \\u0438\\u0441\\u0442\\u043E\\u0440\\u0438\\u0438 \");\n        i0.ɵɵelement(4, \"span\", 2);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(5, \"div\", 3)(6, \"button\", 4);\n        i0.ɵɵlistener(\"click\", function HistoryPageComponent_Template_button_click_6_listener() {\n          return ctx.openFilter();\n        });\n        i0.ɵɵelement(7, \"i\", 5);\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵtemplate(8, HistoryPageComponent_div_8_Template, 2, 0, \"div\", 6);\n        i0.ɵɵtemplate(9, HistoryPageComponent_div_9_Template, 13, 8, \"div\", 7);\n        i0.ɵɵelementEnd();\n      }\n      if (rf & 2) {\n        i0.ɵɵproperty(\"@fade\", undefined);\n        i0.ɵɵadvance(8);\n        i0.ɵɵproperty(\"ngIf\", !ctx.isLoaded);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.isLoaded);\n      }\n    },\n    dependencies: [i5.NgClass, i5.NgIf, i6.LoaderComponent, i7.HistoryChartComponent, i8.HistoryEventsComponent, i9.HistoryFilterComponent],\n    styles: [\".invisible[_ngcontent-%COMP%]{display:none}.history-chart-group[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;justify-content:space-around}.history-chart[_ngcontent-%COMP%]{margin-bottom:30px}.history-chart-outcome[_ngcontent-%COMP%]{color:red}.history-chart-income[_ngcontent-%COMP%]{color:green}h4[_ngcontent-%COMP%]{text-align:center}\"],\n    data: {\n      animation: [fadeStateTrigger]\n    }\n  });\n  return HistoryPageComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}